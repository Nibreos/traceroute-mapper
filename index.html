<!DOCTYPE html>
<html>
<head>
  <base target="_blank">
  <title>Traceroute mapper</title>

  <meta charset="utf-8">
  <meta name="author" content="Stefan Sundin">
  <meta name="description" content="Traceroute mapper">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="img/icon32.png">
  <link rel="license" href="https://www.gnu.org/licenses/gpl-3.0.html" title="GNU GPL v3 or later">
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha384-pdapHxIh7EYuwy6K7iE41uXVxGCXY0sAjBzaElYGJUrzwodck3Lx6IE2lA0rFREo" crossorigin="anonymous">
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-2.1.4.min.js" integrity="sha384-R4/ztc4ZlRqWjqIuvf6RX5yb/v90qNGx6fS48N0tRxiGkqveZETq72KgDVJCp2TC" crossorigin="anonymous"></script>
  <script src="https://maps.google.com/maps/api/js"></script>
<style>
body {
  padding: 0 15px;
  margin-bottom: 100px;
}
a {
  cursor: pointer;
}
.container {
  padding: 0;
}
@media (min-width: 768px) {
  .container {
    max-width: 770px;
  }
}

header {
  margin-top: 25px;
  text-align: center;
}
textarea {
  font-family: monospace;
}
#map {
  height: 500px;
}
</style>
</head>
<body>
  <header>
    <h1 itemprop="name">Traceroute mapper</h1>
  </header>

  <div class="container">
    <hr>
    <p>Run traceroute on your local machine, then paste the output here to map the route. <a>Show example.</a></p>
    <p><textarea class="form-control" rows="20" id="trace"></textarea></p>
    <p><button class="form-control btn btn-primary" id="submit">Map it!</button></p>
    <hr>
    <div id="map"></div>
    <hr>
    <ul>
      <li>Made by <a href="https://stefansundin.github.io/">Stefan Sundin</a>.</li>
      <li>Uses <a href="http://ipinfo.io/">ipinfo.io</a> and Google Maps API.</li>
    </ul>
  </div>

<script>
var map = new google.maps.Map($("#map")[0], {
  center: {lat: 41.5710227, lng: -52.3357077},
  zoom: 2
});

$("#submit").click(function() {
  var text = $("#trace").val();
  // var re = /^ *\d+ (\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;
  var re = / *\d+ .+?[\[ ](\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;
  var r;
  var hosts = [];
  while ((r=re.exec(text)) !== null) {
    hosts.push({ ip: r[1]});
  }
  console.log(hosts);
  hosts.forEach(function(host,i,arr) {
    var ip = host["ip"];
    if (ip.indexOf("192.168.") == 0) {
      console.log(i, ip, "local ip");
    }
    else {
      $.getJSON("http://ipinfo.io/"+ip, function(data) {
        console.log(i, ip, data["loc"], data);
        var ll = data["loc"].split(",");
        arr[i]["loc"] = { lat: parseFloat(ll[0]), lng: parseFloat(ll[1]) };

        // draw marker
        var marker = new google.maps.Marker({
          map: map,
          position: arr[i]["loc"],
          title: JSON.stringify(data)
        });

        // draw lines
        if (arr[i-1] && arr[i-1]["loc"]) {
          // console.log((i-1), "has a marker:", arr[i-1]["loc"]);
          console.log("drawing line between", [ arr[i-1]["loc"], arr[i]["loc"] ]);

          var flightPath = new google.maps.Polyline({
            map: map,
            path: [ arr[i-1]["loc"], arr[i]["loc"] ],
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });
        }
        if (arr[i+1] && arr[i+1]["loc"]) {
          // console.log((i+1), "has a marker:", arr[i+1]["loc"]);
          console.log("drawing line between", [ arr[i]["loc"], arr[i+1]["loc"] ]);

          var flightPath = new google.maps.Polyline({
            map: map,
            path: [ arr[i]["loc"], arr[i+1]["loc"] ],
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });
        }
      });
    }
  });
});
</script>
</body>
</html>
